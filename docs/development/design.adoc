= Design: {project-name}
Vorname Nachname <email@domain.org>; Vorname2 Nachname2 <email2@domain.org>; Vorname3 Nachname3 <email3@domain.org>
{localdatetime}
include::../_includes/default-attributes.inc.adoc[]
// Platzhalter für weitere Dokumenten-Attribute


== Zweck
Dieses Dokument beschreibt wesentliche Entwurfsentscheidungen auf Ebene der Komponenten und Module. Diese dienen als Vorgabe für die Implementierung und erleichtern das Systemverständnis.

== Ausgewählte Sichten
//Entwurfsklassendiagramme, Sequenzdiagramme

== Schnittstellen
:toc:
:toclevels: 3

=== GET /users/

* *Summary:* List Users

* *Beschreibung:* Liefert Liste aller User als JSON-Array.

* *Antworten:*

** `200 OK` – JSON-Array von <<schema-User,User>>-Objekten

[source,json]
----
[
  {
    "id": 1,
    "email": "user@example.com",
    "username": "user",
    "is_active": true,
    "role": "user",
    "hashed_password": "..."
  }
]
----

=== POST /register

* *Summary:* Register User

* *Beschreibung:* Registriert einen neuen Benutzer.

* *Request Body:*

** Content-Type: `application/json`
** Schema: <<schema-UserSchema,UserSchema>>

[source,json]
----
{
  "email": "user@example.com",
  "username": "user",
  "password": "password",
  "role": "user",
  "is_active": false
}
----

* *Antworten:*

** `200 OK` – Erfolgreiche Registrierung (Antwortschema im Code definiert)
** `422 Unprocessable Entity` – Validierungsfehler, siehe <<schema-HTTPValidationError,HTTPValidationError>>

=== POST /login

* *Summary:* Login

* *Beschreibung:* OAuth2 Password Login. Gibt typischerweise ein Access Token zurück (z. B. JWT).

* *Request Body (Form-Data):*

** Content-Type: `application/x-www-form-urlencoded`
** Schema: <<schema-Body_login_login_post,Body_login_login_post>>

* *Antworten:*

** `200 OK` – Login erfolgreich (z. B. Access Token)
** `422 Unprocessable Entity` – Validierungsfehler, siehe <<schema-HTTPValidationError,HTTPValidationError>>

=== GET /verify/{token}

* *Summary:* Verify User

* *Beschreibung:* Verifiziert einen Benutzer anhand eines Tokens (z. B. E-Mail-Bestätigung).

* *Pfadparameter:*

** `token` (string, *required*) – Verifikationstoken

* *Antworten:*

** `200 OK` – HTML-Seite (Content-Type: `text/html`)
** `422 Unprocessable Entity` – Validierungsfehler, siehe <<schema-HTTPValidationError,HTTPValidationError>>

=== GET /users

* *Summary:* Get All Users

* *Beschreibung:* Liefert alle Benutzer (Alternative zu `/users/`; Details abhängig von der Implementierung).

* *Antworten:*

* `200 OK` – Antwortschema im Code definiert

=== GET /secured

* *Summary:* Get All Users (gesichert)

* *Beschreibung:* Wie `/users`, aber nur für authentifizierte Benutzer.
Benötigt ein gültiges Bearer-Token im `Authorization`-Header.

* *Security:*

** `OAuth2PasswordBearer` (Password Flow, Token von `POST /login`)

* *Antworten:*

** `200 OK` – Antwortschema im Code definiert

=== GET /adminsonly

* *Summary:* Get All Users (Admin only)

* *Beschreibung:* Nur für Benutzer mit Admin-Rechten gedacht.
Benötigt ein gültiges Bearer-Token; genaue Rollenprüfung erfolgt serverseitig.

* *Security:*

** `OAuth2PasswordBearer` (Password Flow, Token von `POST /login`)

* *Antworten:*

** `200 OK` – Antwortschema im Code definiert


== Schemas

=== [[schema-Roles]] Roles (Enum)

* *Typ:* `string`

* Mögliche Werte:

** `user`
** `admin`


=== [[schema-User]] User

* *Typ:* `object`

[cols="1,1,2",options="header"]
|===
| Feld
| Typ
| Beschreibung

| `id`
| `integer` \| `null`
| Interne ID des Benutzers.

| `email` (*required*)
| `string` (E-Mail)
| E-Mail-Adresse des Benutzers.

| `username` (*required*)
| `string`
| Anzeigename / Benutzername.

| `is_active`
| `boolean` (default: `false`)
| Gibt an, ob der Benutzer bereits aktiv ist.

| `role` (*required*)
| <<schema-Roles,Roles>>
| Rolle des Benutzers (`user` oder `admin`).

| `hashed_password` (*required*)
| `string`
| Passwort-Hash des Benutzers.
|===


=== [[schema-UserSchema]] UserSchema (Registration)

* *Typ:* `object`

* Wird für `/register` als Request-Body verwendet.

[cols="1,1,2",options="header"]
|===
| Feld
| Typ
| Beschreibung

| `email` (*required*)
| `string` (E-Mail)
| E-Mail-Adresse.

| `username` (*required*)
| `string`
| Benutzername.

| `password` (*required*)
| `string`
| Klartext-Passwort (wird serverseitig gehasht).

| `role` (*required*)
| <<schema-Roles,Roles>>
| Rolle des Benutzers.

| `is_active`
| `boolean` (default: `false`)
| Ob der neue Benutzer direkt aktiv sein soll.
|===


=== [[schema-Body_login_login_post]] Body_login_login_post (Login-Form)

* *Typ:* `object`

* Wird für `/login` als Form-Body verwendet.

[cols="1,1,2",options="header"]
|===
| Feld
| Typ
| Beschreibung

| `username` (*required*)
| `string`
| Benutzername für den Login.

| `password` (*required*)
| `string` (password)
| Passwort für den Login.

| `grant_type`
| `string` \| `null` (Pattern: `^password$`)
| Sollte im Normalfall `"password"` sein.

| `scope`
| `string` (default: `""`)
| Scopes, z. B. `"read write"`.

| `client_id`
| `string` \| `null`
| Optional, Client-ID (falls verwendet).

| `client_secret`
| `string` \| `null`
| Optional, Client-Secret (falls verwendet).
|===


=== [[schema-ValidationError]] ValidationError

* *Typ:* `object`

[cols="1,1,2",options="header"]
|===
| Feld
| Typ
| Beschreibung

| `loc` (*required*)
| `array` von `string` \| `integer`
| Ort des Fehlers (z. B. `["body", "email"]`).

| `msg` (*required*)
| `string`
| Fehlermeldung.

| `type` (*required*)
| `string`
| Fehler-Typ (z. B. `"value_error"`).
|===


=== [[schema-HTTPValidationError]] HTTPValidationError

* *Typ:* `object`

* Wird bei `422 Unprocessable Entity` als Fehlerantwort verwendet.

[cols="1,1,2",options="header"]
|===
| Feld
| Typ
| Beschreibung

| `detail`
| array von <<schema-ValidationError,ValidationError>>
| Liste detaillierter Validierungsfehler.
|===


== Security-Schemes

=== OAuth2PasswordBearer

* *Typ:* `oauth2` (Password Flow)

* *Token-URL:* `POST /login`

* *Scopes:* keine vordefiniert (leeres Objekt `{}` im Schema)

* Wird von folgenden Endpunkten verwendet:

** `GET /secured`
** `GET /adminsonly`


== Datenmodell

=== Entwurfsklassendiagramm (Code wurde mithilfe von KI erstellt)
[plantuml, backend-domain-model, png]
----
@startuml

' ===== Enumerationen =====
enum Roles {
  user
  admin
}

' ===== Domain-Klassen =====
class User {
  +id: int
  +email: string
  +username: string
  +is_active: bool
  +role: Roles
  +hashed_password: string
}

class Company {
  +id: int
  +name: string
}

class CompanyUserLink {
  +user_id: int
  +company_id: int
  +is_owner: bool
}

class Vehicle {
  +id: int
  +name: string
}

class Station {
  +id: int
  +name: string
}

class Workshop {
  +id: int
  +name: string
}

class Route {
  +id: int
  +name: string
  +distance_km: float
}

class Tender {
  +id: int
  +name: string
}

class TenderBid {
  +id: int
  +weekly_subsidy_request: int
}

class Contract {
  +id: int
  +rank: int
}

class Loan {
  +id: int
  +principal: int
}

' ===== Service-/Technik-Klassen =====
class AuthService {
  +create_access_token(user: User): string
  +decode_token(token: string)
  +verify_password(raw: string, hashed: string): bool
}

class UserRepository {
  +create_user(data)
  +get_user_by_username(username: string): User
  +get_users(): List<User>
}

class MailService {
  +send_registration_mail(to: string, token: string, username: string)
}

class Database {
  +create_db_and_tables()
  +get_db(): Session
  +shutdown()
}

' ===== Beziehungen (ohne Multiplikitäten, damit es sicher läuft) =====

User -- CompanyUserLink
Company -- CompanyUserLink

Company -- Vehicle
Company -- Loan
Company -- Contract
Company -- TenderBid

Station -- Route
Station -- Workshop
Workshop -- Vehicle

Route -- Tender
Tender -- TenderBid
Tender -- Contract

AuthService ..> User
AuthService ..> UserRepository
UserRepository ..> Database
MailService ..> User
MailService ..> AuthService
Database ..> User
Database ..> Company
Database ..> Tender
Database ..> Contract
Database ..> Loan

@enduml
----
